#!/bin/bash

# Check if at least two arguments are provided
if [[ $# -lt 2 ]]; then
  echo "Usage: aoc <part> <input>"
  exit 1
fi

file="part$1.cpp"
input="input.$2"

# Automatically recompile when either the input or the file changes
LATEST_FILE_MOD=0
LATEST_INPUT_MOD=0


run_code() {

}


while true; do
    FILE_MOD=`stat -c %Z $file`
    INPUT_MOD=`stat -c %Z $input`

    if [[ LATEST_FILE_MOD != LATEST_INPUT_MOD ] || [ $LATEST_INPUT_MOD != $INPUT_MOD ]] then
        LATEST_FILE_MOD=$FILE_MOD
        LATEST_INPUT_MOD=$INPUT_MOD

        echo -e "\nCompiling source..."

        clang++ -o main \
            -std=c++20 \
            -O3 \
            $file

        if [[ $? != 0 ]] then
            echo -e "Compilation failed.\n"
            continue
        fi
        
        echo -e "Running...\n"

        start_time_us=$(echo $EPOCHREALTIME | tr -d '.')
        ./main < $input
        end_time_us=$(echo $EPOCHREALTIME | tr -d '.')
        rm main

        delta_ms=$(( (end_time_us - start_time_us) / 1000 ))

        printf '\n\n┌%*s\n' 15 | tr ' ' '-'
        echo -e "| Took \e[31m$delta_ms\e[0m ms"
        printf '└%*s' $(($COLUMNS - 1)) | tr ' ' '-'
    fi
    sleep 0.2
done

